services:
  - docker

os: linux

dist: focal

language: python

python:
  - '3.7'

env:
  global:
    - TEST_MODE=1
    - DOCKER_HOST_IP=127.0.0.1
    - BROKER_MANAGEMENT_PORT=15642
    - BROKER_PORT=5642
    - BROKER_USER=infrabbit
    - BROKER_PASS=infrabbit
    - BROKER_URI=amqp://${BROKER_USER}:${BROKER_PASS}@${DOCKER_HOST_IP}:${BROKER_PORT}

branches:
  only:
    - master

install:
  - python -m pip install --no-cache-dir --upgrade pip wheel setuptools
  - python -m pip install --no-cache-dir -r requirements-versioned.txt
  - python -m pip install --no-cache-dir -r requirements-git.txt
  - python -m pip install --no-cache-dir -r requirements-dev.txt
  - python -m pip install -e .

before_script:
  - echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USER --password-stdin
  - dev/start_infrabbitmq3_dependencies.sh

script:
  - sleep 20
  - all_tests

after_script:
  - dev/stop_infrabbitmq3_dependencies.sh
  - docker logout

notifications:
  email:
    - bifer@alea-soluciones.com
